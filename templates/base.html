<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Freelance AI Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 0; background: #0f172a; color: #e5e7eb; }
    header { padding: 1rem 1.5rem; background: #020617; border-bottom: 1px solid #1f2937; }
    main { padding: 1.5rem; }
    a { color: #38bdf8; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header-layout { display:flex; justify-content:space-between; align-items:flex-end; flex-wrap:wrap; gap:0.75rem; }
    .navbar { display:flex; gap:0.75rem; font-size:0.85rem; }
    .navbar a { color:#e5e7eb; opacity:0.8; padding:0.15rem 0.25rem; border-bottom:2px solid transparent; }
    .navbar a:hover { opacity:1; }
    .navbar a.active { border-color:#38bdf8; opacity:1; }
    .filters { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; align-items: flex-end; }
    .filters label { font-size: 0.8rem; color: #9ca3af; display: block; margin-bottom: 0.25rem; }
    .filters input, .filters select { padding: 0.25rem 0.5rem; border-radius: 0.25rem; border: 1px solid #374151; background: #020617; color: #e5e7eb; }
    .filters button { padding: 0.4rem 0.9rem; border-radius: 0.25rem; border: none; background: #38bdf8; color: #020617; font-weight: 600; cursor: pointer; }
    .filters button:hover { background: #0ea5e9; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; }
    .card { background: #020617; border-radius: 0.5rem; padding: 0.9rem 1rem; border: 1px solid #1f2937; display: flex; flex-direction: column; gap: 0.4rem; }
    .card-highlight { border-color: #facc15; box-shadow: 0 0 0 1px #facc15; }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem; }
    .card-title { font-size: 0.95rem; font-weight: 600; }
    .chip-row { display: flex; flex-wrap: wrap; gap: 0.4rem; font-size: 0.75rem; }
    .chip { padding: 0.1rem 0.45rem; border-radius: 999px; border: 1px solid #374151; background: #020617; }
    .chip.good { border-color: #22c55e; color: #4ade80; }
    .chip.warn { border-color: #f97316; color: #fed7aa; }
    .chip.bad { border-color: #ef4444; color: #fecaca; }
    .chip.dach { border-color: #38bdf8; color: #bae6fd; }
    .summary { font-size: 0.8rem; color: #d1d5db; }
    .meta { font-size: 0.75rem; color: #9ca3af; display: flex; flex-wrap: wrap; gap: 0.75rem; }
    .status { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
    .status-seen { color: #9ca3af; }
    .status-analyzed { color: #38bdf8; }
    .status-bid { color: #22c55e; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(15,23,42,0.85); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal-backdrop.open { display: flex; }
    .modal { background: #020617; border-radius: 0.5rem; padding: 1rem 1.25rem; max-width: 720px; width: 100%; max-height: 80vh; overflow: auto; border: 1px solid #1f2937; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .modal-close { border: none; background: transparent; color: #9ca3af; font-size: 1rem; cursor: pointer; }
    .modal-close:hover { color: #e5e7eb; }
    .modal-body { font-size: 0.85rem; color: #d1d5db; }
    .modal-body h3 { margin-top: 0; font-size: 1rem; }
    .modal-body h4 { margin: 0.75rem 0 0.25rem; font-size: 0.9rem; }
    .modal-body p { margin: 0.25rem 0; }
    .preformatted { white-space: pre-wrap; }
  </style>
</head>
<body>
  <header>
    <div class="container header-layout">
      <div>
        <h1 style="font-size:1.2rem; font-weight:600; margin:0;">Freelance AI Dashboard</h1>
        <p style="margin:0.25rem 0 0; font-size:0.8rem; color:#9ca3af;">AI assistant that finds promising Freelancer projects, scores them, and drafts tailored bid proposals for you.</p>
      </div>
      <nav class="navbar">
        <a href="/" {% if active_page == 'projects' %}class="active"{% endif %}>Projects</a>
        <a href="/manual-bid" {% if active_page == 'manual_bid' %}class="active"{% endif %}>Manual Bid</a>
        <a href="/bid-history" {% if active_page == 'bid_history' %}class="active"{% endif %}>Bid History</a>
        <a href="/settings" {% if active_page == 'settings' %}class="active"{% endif %}>Settings</a>
      </nav>
    </div>
  </header>
  <main>
    <div class="container">
      {% block content %}{% endblock %}
    </div>
  </main>
  <div id="detail-modal-backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div id="detail-modal-title" style="font-weight:600;"></div>
        <button type="button" class="modal-close" id="detail-modal-close">&#x2715;</button>
      </div>
      <div class="modal-body" id="detail-modal-body"></div>
    </div>
  </div>
  <script>
    (function() {
      const backdrop = document.getElementById('detail-modal-backdrop');
      const bodyEl = document.getElementById('detail-modal-body');
      const titleEl = document.getElementById('detail-modal-title');
      if (!backdrop || !bodyEl || !titleEl) return;

      function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }

      function openDetail(id, extraHtml) {
        const content = document.getElementById('detail-content-' + id);
        if (!content) return;
        titleEl.textContent = content.getAttribute('data-title') || '';
        bodyEl.innerHTML = content.innerHTML;
        if (extraHtml) {
          const slot = bodyEl.querySelector('.bid-container');
          if (slot) {
            slot.innerHTML = extraHtml;
          } else {
            bodyEl.innerHTML = bodyEl.innerHTML + extraHtml;
          }
        }
        backdrop.classList.add('open');
      }

      function closeDetail() {
        backdrop.classList.remove('open');
        bodyEl.innerHTML = '';
        titleEl.textContent = '';
      }

      backdrop.addEventListener('click', function(e) {
        if (e.target === backdrop) {
          closeDetail();
        }
      });

      const closeBtn = document.getElementById('detail-modal-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeDetail);
      }

      function renderBidHtml(bid, id) {
        var extraHtml = '';
        if (!bid || typeof bid !== 'object') {
          return '';
        }

        if (bid.proposal_text) {
          extraHtml += '<h4>Generated proposal</h4>';
          extraHtml += '<p class="preformatted">' + escapeHtml(bid.proposal_text) + '</p>';
        }

        var plan = bid.milestone_plan || {};
        if (plan.size || plan.count) {
          extraHtml += '<h4>Milestone plan</h4>';
          extraHtml += '<p>Size: ' + escapeHtml(plan.size || '') + ', Count: ' + escapeHtml(plan.count || '') + '</p>';
        }
        if (Array.isArray(plan.milestones) && plan.milestones.length) {
          extraHtml += '<ul>';
          for (var i = 0; i < plan.milestones.length; i++) {
            var m = plan.milestones[i] || {};
            var title = escapeHtml(m.title || m.name || '');
            var amount = m.amount !== undefined && m.amount !== null ? ' (' + escapeHtml(m.amount) + ')' : '';
            var desc = m.description ? ' - ' + escapeHtml(m.description) : '';
            extraHtml += '<li><strong>' + title + amount + '</strong>' + desc + '</li>';
          }
          extraHtml += '</ul>';
        }

        if (bid.free_demo_offered !== undefined) {
          extraHtml += '<p><strong>Free demo offered:</strong> ' + (bid.free_demo_offered ? 'Yes' : 'No') + '</p>';
        }

        extraHtml += '<div style="margin-top:0.75rem;">'
          + '<button type="button" data-regenerate-bid-id="' + String(id) + '" style="padding:0.25rem 0.6rem; border-radius:0.25rem; border:1px solid #22c55e; background:#022c22; color:#bbf7d0; cursor:pointer;">Generate new draft</button>'
          + '</div>';

        return extraHtml;
      }

      function triggerBidGeneration(id, btn) {
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Generating...';

        fetch('/api/generate-bid/' + encodeURIComponent(id), {
          method: 'POST',
        })
          .then(function(resp) { return resp.json(); })
          .then(function(data) {
            btn.disabled = false;
            btn.textContent = originalText;
            if (!data || !data.ok) {
              var msg = (data && data.detail) || (data && data.error) || 'Failed to generate bid.';
              alert(msg);
              return;
            }

            var bid = data.bid || {};
            var extraHtml = renderBidHtml(bid, id);
            openDetail(id, extraHtml);
          })
          .catch(function() {
            btn.disabled = false;
            btn.textContent = originalText;
            alert('Failed to generate bid.');
          });
      }

      // Project-level actions (details, bids, status updates, refresh)
      document.addEventListener('click', function(e) {
        const detailBtn = e.target.closest('[data-detail-id]');
        if (detailBtn) {
          const id = detailBtn.getAttribute('data-detail-id');
          if (id) {
            openDetail(id);
          }
          return;
        }

        const viewBidBtn = e.target.closest('[data-view-bid-id]');
        if (viewBidBtn) {
          const id = viewBidBtn.getAttribute('data-view-bid-id');
          if (!id) return;

          const originalText = viewBidBtn.textContent;
          viewBidBtn.disabled = true;
          viewBidBtn.textContent = 'Loading...';

          fetch('/api/bid/' + encodeURIComponent(id))
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
              viewBidBtn.disabled = false;
              viewBidBtn.textContent = originalText;
              if (!data || !data.ok) {
                var msg = (data && data.detail) || (data && data.error) || 'No bid stored for this project.';
                alert(msg);
                return;
              }

              var bid = data.bid || {};
              var extraHtml = renderBidHtml(bid, id);
              openDetail(id, extraHtml);
            })
            .catch(function() {
              viewBidBtn.disabled = false;
              viewBidBtn.textContent = originalText;
              alert('Failed to load bid.');
            });
          return;
        }

        const regenBtn = e.target.closest('[data-regenerate-bid-id]');
        if (regenBtn) {
          const id = regenBtn.getAttribute('data-regenerate-bid-id');
          if (!id) return;
          triggerBidGeneration(id, regenBtn);
          return;
        }

        const bidBtn = e.target.closest('[data-generate-bid-id]');
        if (bidBtn) {
          const id = bidBtn.getAttribute('data-generate-bid-id');
          if (!id) return;
          triggerBidGeneration(id, bidBtn);
          return;
        }

        const statusBtn = e.target.closest('[data-status-update]');
        if (statusBtn) {
          const id = statusBtn.getAttribute('data-status-id');
          const status = statusBtn.getAttribute('data-status-value');
          const reason = statusBtn.getAttribute('data-status-reason');
          if (!id || !status) return;

          const originalText = statusBtn.textContent;
          statusBtn.disabled = true;
          statusBtn.textContent = 'Updating...';

          fetch('/api/project/' + encodeURIComponent(id) + '/status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: status, reason: reason || null }),
          })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
              statusBtn.disabled = false;
              statusBtn.textContent = originalText;
              if (!data || !data.ok) {
                var msg = (data && data.detail) || (data && data.error) || 'Failed to update status.';
                alert(msg);
                return;
              }
              const card = statusBtn.closest('.card');
              if (card) {
                card.remove();
              }
            })
            .catch(function() {
              statusBtn.disabled = false;
              statusBtn.textContent = originalText;
              alert('Failed to update status.');
            });
        }
      });

      // Refresh controls (only on projects page)
      const refreshBtn = document.getElementById('refresh-btn');
      const autoRefreshCheckbox = document.getElementById('auto-refresh');
      const activePreset = (window.activePreset || '').trim ? (window.activePreset || '').trim() : (window.activePreset || '');

      let refreshInFlight = false;
      let autoTimer = null;

      function performRefresh(isAuto) {
        if (!activePreset) {
          if (!isAuto) {
            alert('Select a preset first, then refresh.');
          }
          return;
        }
        if (refreshInFlight) return;
        refreshInFlight = true;

        if (refreshBtn && !isAuto) {
          refreshBtn.disabled = true;
          refreshBtn.textContent = 'Refreshing...';
        }

        fetch('/api/refresh?preset=' + encodeURIComponent(activePreset), {
          method: 'POST',
        })
          .then(function(resp) { return resp.json(); })
          .then(function(data) {
            refreshInFlight = false;
            if (refreshBtn && !isAuto) {
              refreshBtn.disabled = false;
              refreshBtn.textContent = 'Fetch & analyze new projects';
            }
            if (!data || !data.ok) {
              var msg = (data && data.detail) || (data && data.error) || 'Refresh failed.';
              alert(msg);
              return;
            }
            // Reload to pick up new JSON files.
            window.location.reload();
          })
          .catch(function() {
            refreshInFlight = false;
            if (refreshBtn && !isAuto) {
              refreshBtn.disabled = false;
              refreshBtn.textContent = 'Fetch & analyze new projects';
            }
            alert('Refresh failed.');
          });
      }

      if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
          performRefresh(false);
        });
      }

      function applyAutoRefreshSetting() {
        if (!autoRefreshCheckbox) return;
        if (autoTimer) {
          clearInterval(autoTimer);
          autoTimer = null;
        }
        const enabled = autoRefreshCheckbox.checked;
        try {
          window.localStorage.setItem('dashboard_auto_refresh', enabled ? '1' : '0');
        } catch (e) {}
        if (enabled && activePreset) {
          autoTimer = setInterval(function() {
            performRefresh(true);
          }, 5 * 60 * 1000);
        }
      }

      if (autoRefreshCheckbox) {
        // Initialize from localStorage
        try {
          const stored = window.localStorage.getItem('dashboard_auto_refresh');
          if (stored === '1') {
            autoRefreshCheckbox.checked = true;
          }
        } catch (e) {}
        applyAutoRefreshSetting();
        autoRefreshCheckbox.addEventListener('change', applyAutoRefreshSetting);
      }
    })();
  </script>
</body>
</html>
