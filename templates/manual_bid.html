{% extends "base.html" %}

{% block title %}Manual Bid Generator{% endblock %}

{% block content %}
<style>
  .manual-bid-container {
    max-width: 1100px;
    margin: 0 auto;
  }
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  .page-header h2 {
    margin: 0;
  }
  .stats-bar {
    display: flex;
    gap: 1.5rem;
    background: #f1f5f9;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    font-size: 0.9rem;
  }
  .stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .stat-value {
    font-weight: 700;
    color: #1e293b;
  }
  .stat-label {
    color: #64748b;
  }
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 1.5rem;
  }
  @media (max-width: 900px) {
    .main-grid {
      grid-template-columns: 1fr;
    }
  }
  .form-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1.5rem;
  }
  .form-group {
    margin-bottom: 1.25rem;
  }
  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.4rem;
    color: #333;
    font-size: 0.9rem;
  }
  .form-group textarea,
  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.65rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: inherit;
  }
  .form-group textarea {
    min-height: 180px;
    resize: vertical;
  }
  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: #4a90d9;
    box-shadow: 0 0 0 2px rgba(74, 144, 217, 0.15);
  }
  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
  }
  .form-row .form-group {
    margin-bottom: 0;
  }
  .btn {
    padding: 0.7rem 1.5rem;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }
  .btn-primary {
    background: #2563eb;
    color: white;
  }
  .btn-primary:hover {
    background: #1d4ed8;
  }
  .btn-primary:disabled {
    background: #94a3b8;
    cursor: not-allowed;
  }
  .btn-secondary {
    background: #e2e8f0;
    color: #475569;
  }
  .btn-secondary:hover {
    background: #cbd5e1;
  }
  .btn-row {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
  }
  .sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .sidebar-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
  }
  .sidebar-section h3 {
    margin: 0 0 0.75rem 0;
    font-size: 0.95rem;
    color: #1e293b;
  }
  .prompt-version-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
  }
  .prompt-version-item:hover {
    background: #f1f5f9;
  }
  .prompt-version-item.active {
    background: #dbeafe;
  }
  .prompt-version-item input[type="radio"] {
    width: auto;
  }
  .version-stats {
    margin-left: auto;
    font-size: 0.75rem;
    color: #64748b;
  }
  .badge {
    display: inline-block;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .badge-approved {
    background: #dcfce7;
    color: #166534;
  }
  .badge-testing {
    background: #fef3c7;
    color: #92400e;
  }
  .badge-active {
    background: #dbeafe;
    color: #1e40af;
  }
  .recent-bids-list {
    max-height: 200px;
    overflow-y: auto;
  }
  .recent-bid-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid #f1f5f9;
    font-size: 0.85rem;
  }
  .recent-bid-item:last-child {
    border-bottom: none;
  }
  .recent-bid-title {
    font-weight: 500;
    color: #1e293b;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .recent-bid-meta {
    color: #64748b;
    font-size: 0.75rem;
    margin-top: 0.2rem;
  }
  .result-section {
    margin-top: 1.5rem;
    display: none;
  }
  .result-section.visible {
    display: block;
  }
  .result-box {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1rem;
  }
  .result-box h3 {
    margin: 0 0 1rem 0;
    font-size: 0.95rem;
    color: #475569;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .result-box pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    margin: 0;
    font-family: inherit;
    font-size: 0.9rem;
    line-height: 1.6;
  }
  .result-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: #e0f2fe;
    border-radius: 6px;
    font-size: 0.85rem;
  }
  .result-meta span {
    color: #0369a1;
  }
  .copy-btn {
    background: #e2e8f0;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  .copy-btn:hover {
    background: #cbd5e1;
  }
  .copy-btn.copied {
    background: #86efac;
  }
  .milestone-item {
    padding: 0.6rem 0;
    border-bottom: 1px solid #e2e8f0;
  }
  .milestone-item:last-child {
    border-bottom: none;
  }
  .milestone-title {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.9rem;
  }
  .milestone-desc {
    color: #64748b;
    font-size: 0.85rem;
    margin-top: 0.2rem;
  }
  .loading {
    display: none;
    align-items: center;
    gap: 0.5rem;
    color: #64748b;
  }
  .loading.visible {
    display: flex;
  }
  .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid #e2e8f0;
    border-top-color: #2563eb;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .error-msg {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 1rem;
    border-radius: 6px;
    margin-top: 1rem;
    display: none;
  }
  .error-msg.visible {
    display: block;
  }
  .demo-note {
    background: #fefce8;
    border: 1px solid #fef08a;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    font-size: 0.85rem;
    color: #854d0e;
    margin-top: 1rem;
  }
  .outcome-section {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
  }
  .outcome-section h4 {
    margin: 0 0 0.75rem 0;
    font-size: 0.9rem;
    color: #166534;
  }
  .outcome-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .outcome-btn {
    padding: 0.4rem 0.8rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    background: white;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .outcome-btn:hover {
    border-color: #9ca3af;
  }
  .outcome-btn.selected {
    background: #166534;
    color: white;
    border-color: #166534;
  }
  .help-text {
    font-size: 0.8rem;
    color: #64748b;
    margin-top: 0.3rem;
  }
</style>

<div class="manual-bid-container">
  <div class="page-header">
    <h2>Manual Bid Generator</h2>
    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-value">{{ stats.total_bids }}</span>
        <span class="stat-label">Bids</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ stats.won }}</span>
        <span class="stat-label">Won</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ "%.1f"|format(stats.win_rate) }}%</span>
        <span class="stat-label">Win Rate</span>
      </div>
    </div>
  </div>

  <div class="main-grid">
    <div class="form-section">
      <form id="bidForm">
        <div class="form-group">
          <label for="projectTitle">Project Title</label>
          <input type="text" id="projectTitle" placeholder="e.g., Build a food delivery platform" />
        </div>

        <div class="form-group">
          <label for="projectDescription">Project Description *</label>
          <textarea id="projectDescription" placeholder="Paste the full project description here..." required></textarea>
        </div>

        <div class="form-group">
          <label for="additionalContext">Additional Context (Optional)</label>
          <textarea id="additionalContext" placeholder="Personal details or special context not in profile (e.g., 'I am a bodybuilder myself' for fitness app, 'I have experience with GDPR compliance' for data projects, etc.)"></textarea>
          <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">
            Include personal experience, specific knowledge, or unique qualifications relevant to this project
          </div>
        </div>

        <div class="form-row" style="margin-bottom: 1rem;">
          <div class="form-group">
            <label for="projectType">Project Type</label>
            <select id="projectType">
              {% for pt in project_types %}
              <option value="{{ pt }}">{{ pt.replace('_', ' ').title() }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="languageSelect">Language</label>
            <select id="languageSelect">
              {% for lang in languages %}
              <option value="{{ lang }}">{{ lang.upper() if lang != 'auto' else 'Auto-detect' }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="toneSelect">Tone</label>
            <select id="toneSelect">
              {% for t in tones %}
              <option value="{{ t }}">{{ t.title() if t != 'auto' else 'Auto-detect' }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="form-row" style="margin-bottom: 1rem;">
          <div class="form-group">
            <label for="budgetMin">Budget Min ($)</label>
            <input type="number" id="budgetMin" placeholder="e.g., 200" />
          </div>
          <div class="form-group">
            <label for="budgetMax">Budget Max ($)</label>
            <input type="number" id="budgetMax" placeholder="e.g., 500" />
          </div>
          <div class="form-group">
            <label for="projectUrl">Project URL</label>
            <input type="text" id="projectUrl" placeholder="https://..." />
          </div>
        </div>

        <div class="btn-row">
          <button type="submit" class="btn btn-primary" id="generateBtn">Generate Bid</button>
          <button type="button" class="btn btn-secondary" id="compareBtn">Compare Versions</button>
          <div class="loading" id="loading">
            <div class="spinner"></div>
            <span>Generating...</span>
          </div>
        </div>
      </form>

      <div class="error-msg" id="errorMsg"></div>

      <div class="result-section" id="resultSection">
        <div class="result-meta" id="resultMeta">
          <span><strong>Bid ID:</strong> <span id="bidIdDisplay">-</span></span>
          <span><strong>Prompt:</strong> <span id="promptUsed">-</span></span>
          <span><strong>Model:</strong> <span id="modelUsed">-</span></span>
          <span><strong>Language:</strong> <span id="langDetected">-</span></span>
          <span><strong>Tone:</strong> <span id="toneDetected">-</span></span>
        </div>

        <div class="result-box">
          <h3>
            Proposal Text
            <button class="copy-btn" onclick="copyToClipboard('proposalText', this)">Copy</button>
          </h3>
          <pre id="proposalText"></pre>
        </div>

        <div class="result-box">
          <h3>
            Milestones
            <button class="copy-btn" onclick="copyMilestones(this)">Copy</button>
          </h3>
          <div id="milestonesList"></div>
        </div>

        <div class="demo-note" id="demoNote" style="display: none;">
          <strong>Free demo offered:</strong> <span id="demoReason"></span>
        </div>

        <div class="outcome-section" id="outcomeSection">
          <h4>Track Outcome (for learning)</h4>
          <p class="help-text">Mark what happened with this bid to improve future generations.</p>
          <div class="outcome-buttons">
            <button class="outcome-btn" data-outcome="viewed" onclick="markOutcome(this, 'viewed')">Viewed</button>
            <button class="outcome-btn" data-outcome="engaged" onclick="markOutcome(this, 'engaged')">Engaged/Chat</button>
            <button class="outcome-btn" data-outcome="high_rank" onclick="markOutcome(this, 'high_rank')">High Rank</button>
            <button class="outcome-btn" data-outcome="won" onclick="markOutcome(this, 'won')">Won!</button>
            <button class="outcome-btn" data-outcome="rejected" onclick="markOutcome(this, 'rejected')">No Response</button>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="sidebar-section">
        <h3>Prompt Version</h3>
        <div id="promptVersionsList">
          {% for v in prompt_versions %}
          <label class="prompt-version-item {% if v.is_active %}active{% endif %}">
            <input type="radio" name="promptVersion" value="{{ v.version_key }}" {% if v.is_active %}checked{% endif %}>
            <div>
              <div>{{ v.name }}</div>
              <div style="font-size: 0.75rem; color: #64748b;">{{ v.description[:50] }}{% if v.description|length > 50 %}...{% endif %}</div>
            </div>
            <div class="version-stats">
              {% if v.is_active %}<span class="badge badge-active">Active</span>{% endif %}
              {% if v.is_approved %}<span class="badge badge-approved">Approved</span>{% else %}<span class="badge badge-testing">Testing</span>{% endif %}
            </div>
          </label>
          {% endfor %}
        </div>
      </div>

      <div class="sidebar-section">
        <h3>Recent Bids</h3>
        <div class="recent-bids-list">
          {% for bid in recent_bids %}
          <div class="recent-bid-item">
            <div class="recent-bid-title">{{ bid.project_title }}</div>
            <div class="recent-bid-meta">
              {{ bid.prompt_version }} · 
              {% if bid.was_won %}Won{% elif bid.was_engaged %}Engaged{% elif bid.was_viewed %}Viewed{% else %}Pending{% endif %}
            </div>
          </div>
          {% endfor %}
          {% if not recent_bids %}
          <div style="color: #64748b; font-size: 0.85rem;">No bids yet.</div>
          {% endif %}
        </div>
        <a href="/bid-history" style="display: block; margin-top: 0.75rem; font-size: 0.85rem; color: #2563eb;">View all history →</a>
      </div>
    </div>
  </div>
</div>

<script>
  let currentBidId = null;

  const form = document.getElementById('bidForm');
  const generateBtn = document.getElementById('generateBtn');
  const compareBtn = document.getElementById('compareBtn');
  const loading = document.getElementById('loading');
  const errorMsg = document.getElementById('errorMsg');
  const resultSection = document.getElementById('resultSection');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    await generateBid();
  });

  compareBtn.addEventListener('click', async () => {
    // Get all selected prompt versions
    const checked = document.querySelectorAll('input[name="promptVersion"]:checked');
    if (checked.length === 0) {
      showError('Select at least one prompt version');
      return;
    }
    
    // For compare, we'd need multiple selections - for now just generate with selected
    await generateBid();
  });

  async function generateBid() {
    const description = document.getElementById('projectDescription').value.trim();
    if (!description) {
      showError('Please paste a project description.');
      return;
    }

    // Show loading state
    generateBtn.disabled = true;
    compareBtn.disabled = true;
    loading.classList.add('visible');
    errorMsg.classList.remove('visible');
    resultSection.classList.remove('visible');

    const selectedPrompt = document.querySelector('input[name="promptVersion"]:checked');

    const payload = {
      title: document.getElementById('projectTitle').value.trim() || 'Untitled Project',
      description: description,
      url: document.getElementById('projectUrl').value.trim() || '',
      project_type: document.getElementById('projectType').value,
      language: document.getElementById('languageSelect').value,
      tone: document.getElementById('toneSelect').value,
      prompt_version: selectedPrompt ? selectedPrompt.value : '',
      budget_min: document.getElementById('budgetMin').value || null,
      budget_max: document.getElementById('budgetMax').value || null,
      additional_context: document.getElementById('additionalContext').value.trim() || '',
    };

    try {
      const response = await fetch('/api/manual-bid', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.detail || 'Failed to generate bid');
      }

      // Store bid ID
      currentBidId = data.bid_id;

      // Display metadata
      document.getElementById('bidIdDisplay').textContent = data.bid_id || '-';
      document.getElementById('promptUsed').textContent = data.prompt_version || '-';
      document.getElementById('modelUsed').textContent = data.model_used || '-';
      document.getElementById('langDetected').textContent = data.detected_language || '-';
      document.getElementById('toneDetected').textContent = data.detected_tone || '-';

      // Display results
      document.getElementById('proposalText').textContent = data.proposal_text || '';

      const milestonesList = document.getElementById('milestonesList');
      milestonesList.innerHTML = '';
      if (data.milestone_plan && data.milestone_plan.milestones) {
        data.milestone_plan.milestones.forEach((m, i) => {
          const div = document.createElement('div');
          div.className = 'milestone-item';
          div.innerHTML = `
            <div class="milestone-title">${i + 1}. ${m.title}</div>
            <div class="milestone-desc">${m.description}</div>
          `;
          milestonesList.appendChild(div);
        });
      }

      const demoNote = document.getElementById('demoNote');
      if (data.free_demo_offered) {
        document.getElementById('demoReason').textContent = data.free_demo_reason || 'Yes';
        demoNote.style.display = 'block';
      } else {
        demoNote.style.display = 'none';
      }

      // Reset outcome buttons
      document.querySelectorAll('.outcome-btn').forEach(btn => btn.classList.remove('selected'));

      resultSection.classList.add('visible');

    } catch (err) {
      showError(err.message);
    } finally {
      generateBtn.disabled = false;
      compareBtn.disabled = false;
      loading.classList.remove('visible');
    }
  }

  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.classList.add('visible');
  }

  function copyToClipboard(elementId, btn) {
    const text = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(text).then(() => {
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = 'Copy';
        btn.classList.remove('copied');
      }, 2000);
    });
  }

  function copyMilestones(btn) {
    const items = document.querySelectorAll('#milestonesList .milestone-item');
    let text = '';
    items.forEach((item, i) => {
      const title = item.querySelector('.milestone-title').textContent;
      const desc = item.querySelector('.milestone-desc').textContent;
      text += `${title}\n${desc}\n\n`;
    });
    navigator.clipboard.writeText(text.trim()).then(() => {
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = 'Copy';
        btn.classList.remove('copied');
      }, 2000);
    });
  }

  async function markOutcome(btn, outcome) {
    if (!currentBidId) {
      showError('No bid to mark');
      return;
    }

    const payload = {
      outcome: outcome,
      was_viewed: outcome === 'viewed' || outcome === 'engaged' || outcome === 'won' || outcome === 'high_rank',
      was_engaged: outcome === 'engaged' || outcome === 'won',
      was_won: outcome === 'won',
      was_high_rank: outcome === 'high_rank',
    };

    try {
      const response = await fetch(`/api/bids/${currentBidId}/outcome`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error('Failed to update outcome');
      }

      // Visual feedback
      document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');

    } catch (err) {
      showError(err.message);
    }
  }
</script>
{% endblock %}
